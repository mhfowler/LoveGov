<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Debates</title>
    <link type="text/css" href="/static/base/jquery.ui.all.css" rel="Stylesheet" />
    <link type="text/css" href="/static/base/jquery.ui.datepicker.css" rel="Stylesheet" />
    <script type="text/javascript" src="/static/jquery-1.7.1.js"></script>
    <script type="text/javascript" src="/static/jquery-ui-1.8.16.custom.js"></script>
    <script type="text/javascript" src="/static/jquery.hoverIntent.js"></script>
    <script type="text/javascript" src="/static/dragscrollable.js"></script>
    <script type="text/javascript" src="/static/jquery.livequery.js"></script>
    <script type="text/javascript" src="/static/scrollsync.js"></script>
    <script type="text/javascript" src="/static/jquery.scrollview.js"></script>
    <script type="text/javascript" src="/static/jquery-ui-timepicker-addon.js"></script>
    <script type='text/javascript' src="/static/jquery.ba-outside-events.js"></script>
    <style>
        div#debate
        {
            margin-left: auto;
            margin-right: auto;
            height:750px;
            width:1000px;
            position:static;
            overflow:auto;
        }
        div#left
        {
            float: left;
            height:500px;
            width:340px;
            position:relative;
            overflow:auto;
            background-color:rgb(255,180,180);
        }
        div#right
        {
            float: right;
            height:500px;
            width:340px;
            position:relative;
            overflow:auto;
            background-color:rgb(255,180,180);
        }
        div#moderator
        {
            float: right;
            height:475px;
            width:320px;
            position:relative;
            overflow:auto;
            background-color:rgb(125,125,255);
        }
        div#spectators
        {
            float: right;
            height:250px;
            width:1000px;
            position:relative;
            overflow:auto;
            background-color:rgb(0,255,0);
        }
        div#topic
        {
            font-size: 30px;
            text-align:center;
            top:0px;
            height:40px;
            width:320px;
            position:relative;
            overflow:auto;
            background-color:rgb(50,50,255);
        }
        div#modchat
        {
            top: 0px;
            float:left;
            left:10px;
            height:275px;
            width:300px;
            position:relative;
            overflow:auto;
            background-color:rgb(240,240,255);
        }
        div.timer
        {
            vertical-align: middle;
            font-size: 30px;
            text-align:center;
            float:right;
            top:20px;
            height:40px;
            width:340px;
            position:relative;
            overflow:auto;
            background-color:rgb(200,20,150);
        }
        div.debatechat
        {
            top: 20px;
            float: left;
            left: 10px;
            height:365px;
            width:320px;
            position:relative;
            overflow:auto;
            background-color:rgb(255,255,255);
        }
        div.debatorname
        {
            font-size: 25px;
            text-align:center;
            top: 20px;
            height:35px;
            width:340px;
            position:relative;
            overflow:auto;
            background-color:rgb(200,20,150);
        }
        div#modname
        {
            font-size: 25px;
            text-align:center;
            height:35px;
            width:320px;
            position:relative;
            overflow:auto;
            background-color:rgb(50,50,255);
        }
        div.vote
        {
            vertical-align: middle;
            font-size: 25px;
            text-align:center;
            top: 20px;
            height:35px;
            width:340px;
            position:relative;
            overflow:auto;
        }
        input.vote
        {
            font-size:20px;
            width:100px;
        }
        div.chatinput
        {
            font-size:13px;
            top:0px;
            float: left;
            height:100px;
            width:320px;
            position:relative;
            overflow:auto;
            background-color:rgb(255,255,0);

        }
        textarea.chattext
        {
            position:relative;
            float:left;
            width:315px;
            height:70px;
            vertical-align: top;
            resize: none;
        }
        input.debatesubmit
        {
            position: relative;
            margin-left:110px;
            font-size:13px;
            width:100px;
        }
        div.debatemessages
        {
            border: 0px;
            font-size:13px;
            top:0px;
            height:265px;
            width:320px;
            position:relative;
            overflow:auto;
            background-color:rgb(255,245,255);
        }
        div.debatemessages


    </style>
    <script>
        var r_lastMessageID = -1;
        var l_lastMessageID = -1;
        var a_lastMessageID = -1;
        var s_lastMessageID = -1;
        var debateID = '{{ debateID }}';

        /**
         * This function prints messages to the appropriate chat window
         * @param messages - javascript object
         *      - left_messages, right_messages
         *          0 - message id
         *          1 - sender name
         *          2 - message text
         */
        function printMessages(messages)
        {
            var left_messages = messages['left_messages'];
            var right_messages = messages['right_messages'];
            var left_length = left_messages.length;
            var right_length = right_messages.length;
            for (var i = 0; i < left_length; i++)
            {
                $('#leftdebate').prepend('<div class="debateMessage">' + left_messages[i][1] + ': ' + left_messages[i][2] + '</div><br>');
            }
            for (var j = 0; j < right_length; j++)
            {
                $('#rightdebate').prepend(right_messages[j][1] + ': ' + right_messages[j][2] + '<br>');
            }
            l_lastMessageID = left_messages[left_length-1][0];
            r_lastMessageID = right_messages[right_length-1][0];
        }

        // this function
        function printNewMessage(message, side, inputbox)
        {
            $('#' + side).prepend(message['sender'] + ": " + message['message'] + "<br>");
        }

        function updateMessageID(message)
        {
            var side = message['debate_side'];
            switch(side)
            {
                case 'L':
                    l_lastMessageID = message['id'];
                    break;
                case 'R':
                    r_lastMessageID = message['id'];
                    break;
            }
        }

        /* DOC SETUP */
        $(document).ready(function()
        {
            // To bypass csrf protection on ajax posts.
            $.ajaxSetup({
                        data: {csrfmiddlewaretoken: '{{ csrf_token }}' }}
            );

            // handles user pressing enter to submit text
            $('.chattext').keypress(function(e)
            {
                if (e.which == 13 && !shiftHeld)
                {
                    e.preventDefault();
                    var submitButton = this.id.toString().replace("text","submit");
                    var textArea = this.id.toString();
                    $('#' + submitButton).focus().click();
                    $('#' + textArea).focus();
                }
            });

            var shiftHeld = false;
            $('.chattext').keydown(function(e)
            {
                if (e.which == 16)
                {
                    shiftHeld = true;
                }
            });
            $('.chattext').keyup(function(e)
            {
                if (e.which == 16)
                {
                    shiftHeld = false;
                }
            });



            var posting = false;
            // handles submitting message to server
            $(".debateform").submit(function(event)
            {
                // prevent default submit
                event.preventDefault();
                posting = true;
                // get side where message was submitted from
                var side = this.id.toString().replace("_","");
                // get the input box where message was typed
                var inputbox = this.id.toString().replace("debate","text");
                // get the message
                var message = ($('#' + inputbox).val().toString());
                // regexp for checking if message is all blanks
                var checkAllBlanks = new RegExp(/^\s*$/);
                if (!checkAllBlanks.exec(message))
                {
                    $('#' + inputbox).val('');
                    //alert(message);
                    // insert line breaks appropriately
                    message = message.replace(/\n/g, "<br/>");
                    $.ajax({
                        url:'/action/',
                        type: 'POST',
                        data: {'action':'debateMessage', 'message':message, 'debateID':debateID},
                        success: function(data)
                        {
                            posting = false;
                            var message = eval('(' + data + ')');
                            updateMessageID(message);
                            printNewMessage(message, side, inputbox);
                        },
                        error: function(jqXHR, textStatus, errorThrown)
                        {
                            alert("not working")
                        }
                    });
                }
            });

            // AJAX get funtion
            syncDebate = function()
            {
                if (!posting)
                {
                $.ajax({
                        url:'/access/',
                        type: 'GET',
                        data: {'access':'syncDebate',
                               'debateID': debateID,
                               'lastRightID': r_lastMessageID,
                               'lastLeftID': l_lastMessageID
                              },
                        success: function(data)
                        {
                            var messages = eval('(' + data + ')');
                            printMessages(messages);
                        },
                        error: function(jqXHR, textStatus, errorThrown)
                        {

                        }
                });
                }
            };


            // Runs function initially then on interval
            $(syncDebate);
            setInterval(syncDebate, 5000);
        });


    </script>
</head>

<body>

<div id="debate">
    <div id="left">
        <div class="timer">
            05:00:00
        </div>
        <div class="debatechat">
            <div id="leftdebate" class="debatemessages">

            </div>
            <div class="chatinput">
                {% if user == left_debater %}
                <form name='leftchat' class="debateform" id="left_debate">{% csrf_token %}
                    <textarea name="lefttext" class="chattext" id="left_text"></textarea>
                    <input class="debatesubmit" id="left_submit" type="submit" value="Debate">
                </form>
                {% endif %}
            </div>
        </div>
        <div class="debatorname">
            Maximus Fowler
        </div>
        <div class="vote">
            <form name="voter">
                <input type="button" name="voteright" class="vote" value="Vote">
            </form>
        </div>
    </div>
    <div id="right">
        <div class="timer">
            05:00:00
        </div>
        <div class="debatechat">
            <div id="rightdebate" class="debatemessages" {% if user == left_debater %} style="height:365px"{% endif %}>

            </div>
            <div class="chatinput" {% if user == left_debater %} style="width:0px;height:0px"{% endif %}>
                <form name='rightchat' class="debateform" id="right_debate" >{% csrf_token %}
                    {% if user == right_debater %}
                    <textarea name="lefttext" class="chattext" id="right_text"></textarea>
                    <input class="debatesubmit" id="right_submit"  type="submit" value="Debate">
                    {% endif %}
                </form>
            </div>
        </div>
        <div class="debatorname">
            Clayton Dunwell
        </div>
        <div class="vote">
            <form name="voter">
                <input type="button" name="voteright" class="vote" value="Vote">
            </form>
        </div>
    </div>
    <div id="moderator">
        <div id="topic">
            Health Care Reform
        </div>
        <div id="modchat">

        </div>
        <div id="modname">
            Yoshi Tryba
        </div>
    </div>
    <div id="spectators">
        <div class="spectchat">

        </div>
    </div>
</div>
</body>
</html>